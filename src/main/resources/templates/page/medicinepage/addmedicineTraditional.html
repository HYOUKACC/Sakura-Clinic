<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>添加药品</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
<!--隐藏div，用于弹出接口图片-->

<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-form layui-form-pane" style="text-align: center">

            <fieldset class="layui-elem-field layuimini-search">
                    <legend style="text-align:left">基本数据</legend>
                        <div style="margin: 10px 10px 10px 10px" >
                            <div class="layui-form-item">
                                <div class="layui-row">
                                    <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                        <label class="layui-form-label">药品名</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="medicinesName" autocomplete="off" class="layui-input" id="medicinesNameId" lay-verify="required">
                                        </div>
                                    </div>
                                    <div class="layui-inline"style="margin: 10px 10px 10px 10px">
                                        <label class="layui-form-label">批号</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="batchNumber" autocomplete="off" class="layui-input" id="batchNumberId" lay-verify="required">
                                        </div>
                                    </div>
                                    <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                        <label class="layui-form-label">规格</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="medicinesSpec" autocomplete="off" class="layui-input" id="medicinesSpecId" lay-verify="required">
                                        </div>
                                    </div>
                                </div>

                                <div class="layui-row">
                                    <div class="layui-inline" style="margin: 5px 10px 5px 10px">
                                        <label class="layui-form-label">剂型</label>
                                        <div class="layui-input-inline">
                                            <select name="dosageForm" lay-filter="dosageFormFilter" id="dosageFormId" lay-verify="required" lay-search="">
                                                <option value=""></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-inline"style="margin: 10px 10px 10px 10px">
                                        <label class="layui-form-label">生产日期</label>
                                        <div class="layui-input-inline" >
                                            <input type="text" style="cursor: pointer;" name="productionDate" placeholder="YYYY-MM-DD" id="productionDateId" autocomplete="off" class="layui-input" lay-verify="required|productionDateV">
                                        </div>
                                    </div>
                                    <div class="layui-inline"style="margin: 10px 10px 10px 10px" >
                                        <label class="layui-form-label">过期日期</label>
                                        <div class="layui-input-inline" >
                                            <input type="text" style="cursor: pointer;" name="expiryDate" placeholder="YYYY-MM-DD" id="expiryDateId" autocomplete="off" class="layui-input" lay-verify="required|expiryDateV">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </fieldset>

            <fieldset class="layui-elem-field layuimini-search">
                <legend style="text-align:left">销售数据</legend>
                <div style="margin: 10px 10px 10px 10px">
                    <div class="layui-form-item">
                        <div class="layui-row">
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                            <label class="layui-form-label">药品简码</label>
                            <div class="layui-input-inline">
                                <input type="text" name="medicinesCode" autocomplete="off" class="layui-input" id="medicinesCodeId" lay-verify="required">
                            </div>
                        </div>
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                            <label class="layui-form-label">类型</label>
                            <div class="layui-input-inline">
                                <select name="medicinesCategory" lay-filter="medicinesCategoryFilter" id="medicinesCategoryId" lay-verify="required">
                                    <option value=""></option>
                                    <option value="中药材">中药材</option>
                                </select>
                            </div>
                        </div>
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                            <label class="layui-form-label">库存状态</label>
                            <div class="layui-input-inline">
                                <select name="status" lay-filter="statusFilter" id="statusId" lay-verify="required">
                                    <option value=""></option>
                                    <option value="在售">销售</option>
                                    <option value="在库">在库</option>
                                </select>
                            </div>
                        </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-inline"style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">入库库存</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="number" autocomplete="off" class="layui-input" id="numberId" lay-verify="required">
                                </div>
                            </div>
                            <div class="layui-inline"style="margin: 5px 10px 5px 10px">
                                <label class="layui-form-label">现库存</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="currentNumber" autocomplete="off" class="layui-input" id="currentNumberId" lay-verify="required">
                                </div>
                            </div>
                            <div class="layui-inline" style="margin: 5px 10px 5px 10px">
                                <label class="layui-form-label">销售单位</label>
                                <div class="layui-input-inline">
                                    <select name="saleUnit" lay-filter="saleUnitFilter" id="saleUnitId" lay-verify="required" lay-search="">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-inline"style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">成本价</label>
                                <div class="layui-input-inline">
                                    <input type="text" placeholder="￥" name="primePrice" autocomplete="off" class="layui-input" id="primePriceId" lay-verify="required|primePriceV">
                                </div>
                            </div>
                            <div class="layui-inline"style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">销售价</label>
                                <div class="layui-input-inline">
                                    <input type="text" placeholder="￥" name="price" autocomplete="off" class="layui-input" id="priceId" lay-verify="required|priceV">
                                </div>
                            </div>
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">最后审核人</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="reviewer" autocomplete="off" class="layui-input" id="reviewerId" lay-verify="required">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </fieldset>

            <fieldset class="layui-elem-field layuimini-search">
                <legend style="text-align:left">追溯信息</legend>
                <div style="margin: 10px 10px 10px 10px">
                    <div class="layui-form-item">
                        <div class="layui-row">
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">生产厂商</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="oem" autocomplete="off" class="layui-input" id="oemId" lay-verify="required">
                                </div>
                            </div>
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">供应商</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="supplier" autocomplete="off" class="layui-input" id="supplierId" lay-verify="required">
                                </div>
                            </div>
                            <div class="layui-inline" style="margin: 10px 10px 10px 10px">
                                <label class="layui-form-label">产地</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="sourceArea" autocomplete="off" class="layui-input" id="sourceAreaId" lay-verify="required">
                                </div>
                            </div>
                            <input  type="hidden" name="updateTime" autocomplete="off" class="layui-input" id="updateTimeId"  disabled>
                            <input  type="hidden" name="storageDate" autocomplete="off" class="layui-input" id="storageDateId"  disabled>
                        </div>
                    </div>
                </div>
            </fieldset>

            <div class="layui-form-item">
                <div class="layui-inline" id="submitDiv">
                    <button id="submitBtnId" class="layui-btn" lay-submit="" lay-filter="saveBtn" style="background-color: #3CB371">确认保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script>
    layui.use(['form','laydate'], function () {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.$;
        var laydate = layui.laydate;

        // 验证各种信息
        form.verify({
            medicinesBarV : function(value){
                if(value.length != 13){
                    return '条形码必须13位';
                }
            },
            primePriceV:[ // 以数字开头，+号前面的字符可以出现多次，？号前面字符可以出现0次或一次，$以此结尾
                /^(0|([1-9]\d*))(\.\d+)?$/,'成本价格式不正确'
            ],
            priceV:[ // 以数字开头，+号前面的字符可以出现多次，？号前面字符可以出现0次或一次，$以此结尾
                /^(0|([1-9]\d*))(\.\d+)?$/,'售价价格式不正确'
            ]
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {

            // 向后台发送ajax请求
            $.post("/addmedicinenow",data.field,function (data) {
                // 关闭添加药品窗口
                var trans=JSON.parse(data); // 把jsong转换为数组
                var txt="";
                if(trans['msg']=='success'){
                    txt="入库成功！";// 正常情况，一般都是入库成功，前端已经验证了一些必要的信息了
                }else{
                    txt="入库失败，请重新尝试！"; // 同一个药品，相同批号的药品入库会失败
                }
                // 关闭弹出层
                var iframeIndex = parent.layer.getFrameIndex(window.name);
                parent.layer.close(iframeIndex);
                parent.layer.msg(txt,{icon: 1});
            });

            return false;
        });

        // 封装函数，时间戳格式化函数
        function timestampToTime(timestamp) {
            //时间戳为10位需*1000，时间戳为13位的话不需乘1000
            var date = new Date(timestamp);
            Y = date.getFullYear() + '-';
            M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            D = date.getDate() + ' ';
            h = date.getHours() + ':';
            m = date.getMinutes() + ':';
            s = date.getSeconds();
            return Y+M+D+h+m+s;
        }

        $('#storageDateId').val(function () {
            var nowTime=new Date();
            return timestampToTime(nowTime.getTime());
        });

        $('#updateTimeId').val(function () {
            var nowTime=new Date();
            return timestampToTime(nowTime.getTime());
        });


        // 生产日期选择
        laydate.render({
            elem: '#productionDateId',
            trigger: 'click', // 日期只读
            theme: '#3CB371', // 主题色
            showBottom: false
        });

        // 过期日期选择
        laydate.render({
            elem: '#expiryDateId',
            trigger: 'click', // 日期只读
            theme: '#3CB371', // 主题色
            showBottom: false,
            min:0 // 过期日期不能小于今天
        });

        // 监听药品名输入框的变化，为自动转换药品简码做准备
        $('#medicinesNameId').on("input propertychange",function () {

            var str={"str":$('#medicinesNameId').val()};
            // 执行ajax请求
           $.post("/transToFirst",str,function (data) {
               var message=JSON.parse(data);// 把json转换为数组
               $('#medicinesCodeId').val(message['data']);
           });


        });

        // 监听药品条形码框，限制长度必须为13位，才去调用网络接口，不能浪费宝贵的接口资源
        $('#medicinesBarcodeId').keydown(function(event){
            if(event.keyCode==13){
                var medicinesBarcode=$("#medicinesBarcodeId").val();
                var length=medicinesBarcode.length;
                if(length==13){ // 长度是13位，此时调用网络接口
                    $("#medicinesNameId").val();
                    $("#medicinesCodeId").val();
                    $("#oemId").val();
                    var str={"medicinesBarcode":medicinesBarcode};
                    $.post("/addPageGetInfo",str,function (data) {
                       // 查询可能失败，先判断status里的数据
                        var trans=JSON.parse(data);
                        if(trans["status"]=="200"){
                            // 查询成功，有数据，给输入框自动赋值
                            // 判断img是否为空
                            if(trans["img"]!="empty"){
                                // 有图片，修改图片src
                                $("#medicineImgId").attr("src",trans["img"]);
                            }else {
                                $("#medicineImgId").attr("src","../../images/notfoundInfo2.png");
                            }
                            // 自动弹出图片
                            // layer.open({
                            //     type: 1,
                            //     title: false,
                            //     closeBtn: 0,
                            //     shade: [0],
                            //     area: ['auto'],
                            //     skin: 'layui-layer-nobg', //没有背景色
                            //     shadeClose: true,
                            //     offset: 'rt',
                            //     time: 1000, //2秒后自动关闭
                            //     content: $('#medicineImgDivId')
                            // });
                            $("#medicinesNameId").val(trans["medicinesName"]);
                            $("#medicinesCodeId").val(trans["medicinesCode"]);
                            $("#oemId").val(trans["oem"]);

                        }else{
                            // 查询失败，弹出暂无数据提示框
                            layer.msg('抱歉，暂无数据', {icon: 5,time: 500});
                        }
                    });
                }
            }
        });

        // 网络数据不稳定，图片可能加载过慢，后台下载
        // layer.open({
        //     type: 1,
        //     title: false,
        //     closeBtn: 0,
        //     shade: [0],
        //     area: ['auto'],
        //     skin: 'layui-layer-nobg', //没有背景色
        //     shadeClose: true,
        //     offset: 'rt',
        //     time: 5000, //2秒后自动关闭
        //     content: $('#medicineImgDivId')
        // });

        // 当鼠标移入时，再弹出图片，让图片预载一下
        $("#submitBtnId").mouseenter(function(){
            layer.open({
                type: 1,
                closeBtn: 0,
                shade: false,
                title: false, //不显示标题
                offset: 'rt',
                time: 1000, //2秒后自动关闭
                content: $('#medicineImgDivId') //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
        });

        // ajax加载包装单位
        $.ajax({
            url: '/selectUnit',
            dataType: 'json',
            type: 'get',
            success: function (data) {
                var trans=data['data'];
                $.each(trans, function (index, item) {
                    // 下拉菜单里添加元素
                    $("#medicinesUnitId").append('<option value="'+item.medicinesUnitText+'">'+item.medicinesUnitText+'</option>');
                    $("#saleUnitId").append('<option value="'+item.medicinesUnitText+'">'+item.medicinesUnitText+'</option>');
                });
                form.render("select");
            }
        });

        // ajax加载剂型
        $.ajax({
            url: '/selectDosageForm',
            dataType: 'json',
            type: 'get',
            success: function (data) {
                var trans=data['data'];
                $.each(trans, function (index, item) {
                    // 下拉菜单里添加元素
                    $("#dosageFormId").append('<option value="'+item.dosageFormName+'">'+item.dosageFormName+'</option>');
                });
                form.render("select");
            }
        });





    });
</script>
</body>
</html>